import { NetworkManager } from './core/network.js';
import { WorldState } from './world/worldState.js';
import { InputHandler } from './core/input.js';
import { SaveSystem } from './core/saveSystem.js';
import { ChatSystem } from './core/chatSystem.js';
import { UIManager } from './managers/UIManager.js';
import { GameManager } from './managers/GameManager.js';

// 1. Instanciação dos Sistemas
const net = new NetworkManager();
const input = new InputHandler(); 
const worldState = new WorldState();
const saveSystem = new SaveSystem();
const chat = new ChatSystem();
const ui = new UIManager();

// 2. Injeção de Dependências (O GameManager precisa de acesso a tudo)
const gameManager = new GameManager(net, input, worldState, saveSystem, chat, ui);

// 3. Configuração de Travamento de Input (Quando digita no chat, o boneco não anda)
chat.onChatOpen = () => input.setChatMode(true);
chat.onChatClose = () => input.setChatMode(false);

// 4. Lógica dos Botões do Menu (Lobby)

// --- Botão HOSPEDAR ---
const btnCreate = document.getElementById('btn-create');
if (btnCreate) {
    btnCreate.onclick = () => {
        // Tenta ativar tela cheia no mobile
        if (window.requestGameFullscreen) window.requestGameFullscreen();

        // Coleta dados do HTML
        const nick = document.getElementById('host-nickname').value.trim() || "Host";
        const id = document.getElementById('create-id').value.trim();
        const pass = document.getElementById('create-pass').value.trim();
        const seed = document.getElementById('world-seed').value.trim() || "FLORESTA";
        
        if(!id) {
            ui.displayStatus("Erro: Crie um ID para a sala!");
            return;
        }

        ui.displayStatus(`Criando sala ${id}...`);
        
        // Inicializa a Rede como Host
        net.init(id, (ok, errorType) => {
            if(ok) {
                // Configura a sala e callbacks de dados
                net.hostRoom(id, pass, seed, 
                    () => worldState.getFullState(), // Callback para enviar estado do mundo
                    (guestNick) => gameManager.guestDataDB[guestNick], // Callback para enviar dados do guest salvo
                    () => gameManager.guestDataDB // Callback para sincronizar DB
                );
                
                // Inicia o jogo
                gameManager.startGame(seed, id, nick, true);
            } else { 
                ui.displayStatus(`Erro ao criar: ${errorType}`);
            }
        });
    };
}

// --- Botão ENTRAR ---
const btnJoin = document.getElementById('btn-join');
if (btnJoin) {
    btnJoin.onclick = () => {
        if (window.requestGameFullscreen) window.requestGameFullscreen();

        const nick = document.getElementById('join-nickname').value.trim() || "Guest";
        const id = document.getElementById('join-id').value.trim();
        const pass = document.getElementById('join-pass').value.trim();
        
        if(!id) {
            ui.displayStatus("Erro: Digite o ID da sala!");
            return;
        }

        ui.displayStatus(`Procurando sala ${id}...`);

        // Inicializa a Rede como Guest (ID null, o PeerJS gera um aleatório)
        net.init(null, (ok, err) => { 
            if(ok) {
                net.joinRoom(id, pass, nick); 
            } else {
                ui.displayStatus(`Erro de conexão: ${err}`);
            }
        });
    };
}

// 5. Lógica dos Botões de Interface (Modais)

// Aceitar Convite de Party
const btnAccept = document.getElementById('btn-accept-invite');
if (btnAccept) {
    btnAccept.onclick = () => {
        if (gameManager.pendingInviteFrom) {
            gameManager.currentPartyPartner = gameManager.pendingInviteFrom;
            
            // Avisa o host/outro player que aceitou
            net.sendPayload({ 
                type: 'PARTY_ACCEPT', 
                fromId: gameManager.localPlayer.id, 
                fromNick: gameManager.localPlayer.nickname 
            }, gameManager.pendingInviteFrom);
            
            chat.addMessage('SYSTEM', null, `Você entrou no grupo.`);
            chat.openPartyTab();
            ui.closePartyInvite();
            gameManager.pendingInviteFrom = null;
        }
    };
}

// Ação do Modal de Jogador (Convidar/Sair)
const btnPartyAction = document.getElementById('btn-party-action');
if (btnPartyAction) {
    btnPartyAction.onclick = () => {
        const targetId = gameManager.selectedPlayerId;
        if (!targetId) return;

        if (gameManager.currentPartyPartner === targetId) {
            // Se já é parceiro, o botão serve para SAIR
            net.sendPayload({ type: 'PARTY_LEAVE', fromId: gameManager.localPlayer.id }, targetId);
            chat.addMessage('SYSTEM', null, `Grupo desfeito.`);
            gameManager.currentPartyPartner = null;
            chat.closePartyTab();
        } else {
            // Se não é, serve para CONVIDAR
            net.sendPayload({ 
                type: 'PARTY_INVITE', 
                fromId: gameManager.localPlayer.id, 
                fromNick: gameManager.localPlayer.nickname 
            }, targetId);
            chat.addMessage('SYSTEM', null, `Convite enviado.`);
        }
        ui.closePlayerModal();
    };
}
